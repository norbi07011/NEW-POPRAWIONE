version: '3'

# BTCPayServer - Self-Hosted Payment Gateway
# 0% Fees | Lightning Network | Full Privacy

services:
  # BTCPayServer main application
  btcpayserver:
    image: btcpayserver/btcpayserver:1.13.1
    restart: unless-stopped
    environment:
      BTCPAY_POSTGRES: User ID=postgres;Host=postgres;Port=5432;Database=btcpayserver;Password=${POSTGRES_PASSWORD}
      BTCPAY_NETWORK: mainnet
      BTCPAY_BIND: 0.0.0.0:49392
      BTCPAY_EXTERNALURL: https://pay.messubouw.com
      BTCPAY_ROOTPATH: /
      BTCPAY_SSHCONNECTION: "root@host.docker.internal"
      BTCPAY_SSHTRUSTEDFINGERPRINTS: ${SSH_FINGERPRINT}
      BTCPAY_CHAINS: "btc"
      BTCPAY_BTCEXPLORERURL: http://nbxplorer:32838/
      BTCPAY_BTCLIGHTNING: type=lnd-rest;server=https://lnd:8080/;macaroonfilepath=/etc/lnd/admin.macaroon;certthumbprint=${LND_CERT_THUMBPRINT}
    ports:
      - "49392:49392"
    volumes:
      - btcpay_datadir:/datadir
      - lnd_datadir:/etc/lnd
    depends_on:
      - postgres
      - nbxplorer
      - lnd

  # NBXplorer - Bitcoin indexer
  nbxplorer:
    image: nicolasdorier/nbxplorer:2.4.5
    restart: unless-stopped
    environment:
      NBXPLORER_NETWORK: mainnet
      NBXPLORER_BIND: 0.0.0.0:32838
      NBXPLORER_CHAINS: "btc"
      NBXPLORER_BTCRPCURL: http://bitcoind:8332/
      NBXPLORER_BTCRPCUSER: ${BTC_RPC_USER}
      NBXPLORER_BTCRPCPASSWORD: ${BTC_RPC_PASSWORD}
    ports:
      - "32838:32838"
    volumes:
      - nbxplorer_datadir:/datadir
    depends_on:
      - bitcoind

  # Bitcoin Core - Full node
  bitcoind:
    image: btcpayserver/bitcoin:26.0
    restart: unless-stopped
    environment:
      BITCOIN_NETWORK: mainnet
      BITCOIN_EXTRA_ARGS: |
        server=1
        rpcuser=${BTC_RPC_USER}
        rpcpassword=${BTC_RPC_PASSWORD}
        rpcallowip=0.0.0.0/0
        whitelist=0.0.0.0/0
        txindex=1
        prune=0
    ports:
      - "8333:8333"
      - "8332:8332"
    volumes:
      - bitcoin_datadir:/data

  # LND - Lightning Network
  lnd:
    image: btcpayserver/lnd:v0.17.3-beta
    restart: unless-stopped
    environment:
      LND_CHAIN: bitcoin
      LND_ENVIRONMENT: mainnet
      LND_EXTRA_ARGS: |
        restlisten=0.0.0.0:8080
        rpclisten=0.0.0.0:10009
        bitcoin.active=1
        bitcoin.mainnet=1
        bitcoin.node=bitcoind
        bitcoind.rpchost=bitcoind:8332
        bitcoind.rpcuser=${BTC_RPC_USER}
        bitcoind.rpcpass=${BTC_RPC_PASSWORD}
        bitcoind.zmqpubrawblock=tcp://bitcoind:28332
        bitcoind.zmqpubrawtx=tcp://bitcoind:28333
    ports:
      - "9735:9735"
      - "8080:8080"
      - "10009:10009"
    volumes:
      - lnd_datadir:/data
      - lnd_datadir:/root/.lnd
    depends_on:
      - bitcoind

  # PostgreSQL - Database
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: btcpayserver
      POSTGRES_USER: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_datadir:/var/lib/postgresql/data

  # Nginx - Reverse proxy with SSL
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot_certs:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    depends_on:
      - btcpayserver

  # Certbot - SSL certificates
  certbot:
    image: certbot/certbot
    restart: unless-stopped
    volumes:
      - certbot_certs:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  btcpay_datadir:
  nbxplorer_datadir:
  bitcoin_datadir:
  lnd_datadir:
  postgres_datadir:
  certbot_certs:
  certbot_www:

networks:
  default:
    name: btcpayserver-network
